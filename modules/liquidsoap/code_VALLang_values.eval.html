<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of class attributes" rel=Appendix href="index_attributes.html">
<link title="Index of class methods" rel=Appendix href="index_methods.html">
<link title="Index of classes" rel=Appendix href="index_classes.html">
<link title="Index of class types" rel=Appendix href="index_class_types.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="AFrame" rel="Chapter" href="AFrame.html">
<link title="Audio_converter" rel="Chapter" href="Audio_converter.html">
<link title="Clock" rel="Chapter" href="Clock.html">
<link title="Configure" rel="Chapter" href="Configure.html">
<link title="Decoder" rel="Chapter" href="Decoder.html">
<link title="Doc" rel="Chapter" href="Doc.html">
<link title="Dyntools" rel="Chapter" href="Dyntools.html">
<link title="Encoder" rel="Chapter" href="Encoder.html">
<link title="Frame" rel="Chapter" href="Frame.html">
<link title="Generated" rel="Chapter" href="Generated.html">
<link title="Generator" rel="Chapter" href="Generator.html">
<link title="Http" rel="Chapter" href="Http.html">
<link title="IoRing" rel="Chapter" href="IoRing.html">
<link title="Lang" rel="Chapter" href="Lang.html">
<link title="Lang_types" rel="Chapter" href="Lang_types.html">
<link title="Lang_values" rel="Chapter" href="Lang_values.html">
<link title="MFrame" rel="Chapter" href="MFrame.html">
<link title="Ogg_muxer" rel="Chapter" href="Ogg_muxer.html">
<link title="Output" rel="Chapter" href="Output.html">
<link title="Playlist_parser" rel="Chapter" href="Playlist_parser.html">
<link title="Plug" rel="Chapter" href="Plug.html">
<link title="Request" rel="Chapter" href="Request.html">
<link title="Request_source" rel="Chapter" href="Request_source.html">
<link title="Server" rel="Chapter" href="Server.html">
<link title="Source" rel="Chapter" href="Source.html">
<link title="Switch" rel="Chapter" href="Switch.html">
<link title="Synthesized" rel="Chapter" href="Synthesized.html">
<link title="Tutils" rel="Chapter" href="Tutils.html">
<link title="VFrame" rel="Chapter" href="VFrame.html">
<link title="Video_converter" rel="Chapter" href="Video_converter.html">
<link title="Wav" rel="Chapter" href="Wav.html"><title>liquidsoap : Lang_values.eval</title>
</head>
<body>
<code class="code"><span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;eval&nbsp;~env&nbsp;tm&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mk&nbsp;v&nbsp;=&nbsp;{&nbsp;<span class="constructor">V</span>.t&nbsp;=&nbsp;tm.t&nbsp;;&nbsp;<span class="constructor">V</span>.value&nbsp;=&nbsp;v&nbsp;}&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;tm.term&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Unit</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">Unit</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bool</span>&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">Bool</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">Int</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">String</span>&nbsp;&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">String</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Float</span>&nbsp;&nbsp;&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">Float</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Encoder</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">Encoder</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">List</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;(eval&nbsp;~env)&nbsp;l))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Product</span>&nbsp;(a,b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">Product</span>&nbsp;(eval&nbsp;~env&nbsp;a,&nbsp;eval&nbsp;~env&nbsp;b))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Ref</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">Ref</span>&nbsp;(ref&nbsp;(eval&nbsp;~env&nbsp;v)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Get</span>&nbsp;r&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;(eval&nbsp;~env&nbsp;r).<span class="constructor">V</span>.value&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">V</span>.<span class="constructor">Ref</span>&nbsp;r&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Set</span>&nbsp;(r,v)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;(eval&nbsp;~env&nbsp;r).<span class="constructor">V</span>.value&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">V</span>.<span class="constructor">Ref</span>&nbsp;r&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r&nbsp;:=&nbsp;eval&nbsp;~env&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mk&nbsp;<span class="constructor">V</span>.<span class="constructor">Unit</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Let</span>&nbsp;{gen=generalized;var=x;def=v;body=b}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;It&nbsp;should&nbsp;be&nbsp;the&nbsp;case&nbsp;that&nbsp;generalizable&nbsp;variables&nbsp;don't<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;get&nbsp;instantiated&nbsp;in&nbsp;any&nbsp;way&nbsp;when&nbsp;evaluating&nbsp;the&nbsp;definition.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;But&nbsp;we&nbsp;don't&nbsp;double-check&nbsp;it.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;eval&nbsp;~env&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval&nbsp;~env:((x,(generalized,v))::env)&nbsp;b<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fun</span>&nbsp;(fv,p,body)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Unlike&nbsp;OCaml&nbsp;we&nbsp;always&nbsp;evaluate&nbsp;default&nbsp;values,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;we&nbsp;do&nbsp;that&nbsp;early.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;I&nbsp;think&nbsp;the&nbsp;only&nbsp;reason&nbsp;is&nbsp;homogeneity&nbsp;with&nbsp;FFI,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;which&nbsp;are&nbsp;declared&nbsp;with&nbsp;values&nbsp;as&nbsp;defaults.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;p&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(lbl,var,_,<span class="constructor">Some</span>&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;lbl,var,<span class="constructor">Some</span>&nbsp;(eval&nbsp;~env&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(lbl,var,_,<span class="constructor">None</span>)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;lbl,var,<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;env&nbsp;=&nbsp;<span class="constructor">List</span>.filter&nbsp;(<span class="keyword">fun</span>&nbsp;(x,_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Vars</span>.mem&nbsp;x&nbsp;fv)&nbsp;env&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">Fun</span>&nbsp;(p,[],env,body))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Var</span>&nbsp;var&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lookup&nbsp;env&nbsp;var&nbsp;tm.t<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Seq</span>&nbsp;(a,b)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(eval&nbsp;~env&nbsp;a)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval&nbsp;~env&nbsp;b<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">App</span>&nbsp;(f,l)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apply&nbsp;~t:tm.t<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(eval&nbsp;~env&nbsp;f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;(<span class="keyword">fun</span>&nbsp;(l,t)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;l,&nbsp;eval&nbsp;~env&nbsp;t)&nbsp;l)<br>
<br>
<span class="keyword">and</span>&nbsp;apply&nbsp;~t&nbsp;f&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mk&nbsp;v&nbsp;=&nbsp;{&nbsp;<span class="constructor">V</span>.t&nbsp;=&nbsp;t&nbsp;;&nbsp;<span class="constructor">V</span>.value&nbsp;=&nbsp;v&nbsp;}&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Extract&nbsp;the&nbsp;components&nbsp;of&nbsp;the&nbsp;function,&nbsp;whether&nbsp;it's&nbsp;explicit<br>
&nbsp;&nbsp;&nbsp;*&nbsp;or&nbsp;foreign,&nbsp;together&nbsp;with&nbsp;a&nbsp;rewrapping&nbsp;function&nbsp;for&nbsp;creating<br>
&nbsp;&nbsp;&nbsp;*&nbsp;a&nbsp;closure&nbsp;in&nbsp;case&nbsp;of&nbsp;partial&nbsp;application.&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;p,pe,f,rewrap&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;f.<span class="constructor">V</span>.value&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">V</span>.<span class="constructor">Fun</span>&nbsp;(p,pe,e,body)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p,pe,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;pe&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;eval&nbsp;~env:(<span class="constructor">List</span>.rev_append&nbsp;pe&nbsp;e)&nbsp;body),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;p&nbsp;pe&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">Fun</span>&nbsp;(p,pe,e,body)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">V</span>.<span class="constructor">FFI</span>&nbsp;(p,pe,f)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p,pe,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;pe&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;(<span class="constructor">List</span>.rev&nbsp;pe)&nbsp;t),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;p&nbsp;pe&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mk&nbsp;(<span class="constructor">V</span>.<span class="constructor">FFI</span>&nbsp;(p,pe,f)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pe,p&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.fold_left<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(pe,p)&nbsp;(lbl,v)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(_,var,_),p&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_first&nbsp;(<span class="keyword">fun</span>&nbsp;(l,_,_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;l=lbl)&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(var,([],v))::pe,&nbsp;p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pe,p)&nbsp;l<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">List</span>.exists&nbsp;(<span class="keyword">fun</span>&nbsp;(_,_,x)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x=<span class="constructor">None</span>)&nbsp;p&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Partial&nbsp;application.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewrap&nbsp;p&nbsp;pe<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;XXX&nbsp;Contrary&nbsp;to&nbsp;older&nbsp;implementation&nbsp;of&nbsp;eval,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;we&nbsp;do&nbsp;not&nbsp;assign&nbsp;location-based&nbsp;IDs&nbsp;to&nbsp;sources<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(e.g.&nbsp;add@L13C4).&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pe&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.fold_left<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;pe&nbsp;(_,var,v)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(var,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Set&nbsp;the&nbsp;position&nbsp;information&nbsp;on&nbsp;FFI's&nbsp;default&nbsp;values.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Cf.&nbsp;r5008:&nbsp;if&nbsp;an&nbsp;Invalid_value&nbsp;is&nbsp;raised&nbsp;on&nbsp;a&nbsp;default&nbsp;value,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;which&nbsp;happens&nbsp;with&nbsp;the&nbsp;mount/name&nbsp;params&nbsp;of&nbsp;output.icecast.*,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;printing&nbsp;of&nbsp;the&nbsp;error&nbsp;should&nbsp;succeed&nbsp;at&nbsp;getting&nbsp;a&nbsp;position<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;information.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">Utils</span>.get_some&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;v&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">V</span>.t&nbsp;=&nbsp;<span class="constructor">T</span>.make&nbsp;~pos:t.<span class="constructor">T</span>.pos&nbsp;(<span class="constructor">T</span>.<span class="constructor">Link</span>&nbsp;v.<span class="constructor">V</span>.t)&nbsp;})::pe)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pe&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;f&nbsp;pe&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Similarly&nbsp;here,&nbsp;the&nbsp;result&nbsp;of&nbsp;an&nbsp;FFI&nbsp;call&nbsp;should&nbsp;have&nbsp;some&nbsp;position<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;information.&nbsp;For&nbsp;example,&nbsp;if&nbsp;we&nbsp;build&nbsp;a&nbsp;fallible&nbsp;source&nbsp;and&nbsp;pass<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;it&nbsp;to&nbsp;an&nbsp;operator&nbsp;that&nbsp;expects&nbsp;an&nbsp;infallible&nbsp;one,&nbsp;an&nbsp;error<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;is&nbsp;issued&nbsp;about&nbsp;that&nbsp;FFI-made&nbsp;value&nbsp;and&nbsp;a&nbsp;position&nbsp;is&nbsp;needed.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;v&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">V</span>.t&nbsp;=&nbsp;<span class="constructor">T</span>.make&nbsp;~pos:t.<span class="constructor">T</span>.pos&nbsp;(<span class="constructor">T</span>.<span class="constructor">Link</span>&nbsp;v.<span class="constructor">V</span>.t)&nbsp;}</code></body></html>